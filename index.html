<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IT Service Management - ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .pink-gradient { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
    .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .status-waiting { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
    .status-progress { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }
    .status-done { background: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
    .tab-active { border-bottom: 4px solid #ec4899; color: #ec4899; font-weight: 700; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ec4899; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
  </style>
</head>
<body class="h-full bg-slate-50">

  <div id="loader" class="overlay">
    <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
      <div class="loader mb-4"></div>
      <p class="text-pink-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
  </div>

  <div id="loginPage" class="flex items-center justify-center min-h-screen p-4">
    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 border-t-8 border-pink-500">
      <div class="text-center mb-8">
        <img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" class="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800">IT UDON HOSPITAL</h1>
        <p class="text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
      </div>
      <div class="space-y-4">
        <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (UserPN)" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-pink-400 outline-none transition">
        <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-pink-400 outline-none transition">
        <button onclick="doLogin()" class="w-full pink-gradient text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <div id="mainApp" class="hidden min-h-screen flex flex-col">
    <header class="pink-gradient text-white p-4 shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
          <img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" class="w-10 h-10 bg-white rounded-full p-1">
          <div>
            <h2 class="font-bold leading-none">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h2>
            <p class="text-xs opacity-80">IT Service System</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right hidden sm:block">
            <p id="displayUserName" class="text-sm font-bold leading-none"></p>
            <p id="displayUserRole" class="text-[10px] opacity-80 uppercase"></p>
          </div>
          <button onclick="location.reload()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition">üö™</button>
        </div>
      </div>
    </header>

    <nav class="bg-white shadow-sm sticky top-[72px] z-40">
      <div class="max-w-7xl mx-auto flex">
        <button onclick="switchTab(1)" id="tabBtn1" class="flex-1 py-4 text-sm font-medium tab-active">Dashboard</button>
        <button onclick="switchTab(2)" id="tabBtn2" class="flex-1 py-4 text-sm font-medium text-gray-500">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <button onclick="switchTab(3)" id="tabBtn3" class="flex-1 py-4 text-sm font-medium text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto w-full p-4 flex-grow">
      
      <div id="tab1" class="space-y-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-pink-500 text-center">
            <p class="text-xs text-gray-500 uppercase">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="countTotal" class="text-2xl font-bold text-gray-800">0</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500 text-center">
            <p class="text-xs text-gray-500 uppercase">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</p>
            <p id="countWaiting" class="text-2xl font-bold text-red-500">0</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500 text-center">
            <p class="text-xs text-gray-500 uppercase">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</p>
            <p id="countPending" class="text-2xl font-bold text-yellow-500">0</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500 text-center">
            <p class="text-xs text-gray-500 uppercase">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
            <p id="countDone" class="text-2xl font-bold text-green-500">0</p>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
          <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <button onclick="loadData()" class="text-xs text-pink-500 font-bold">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="bg-gray-50 text-gray-400 uppercase text-[10px]">
                <tr>
                  <th class="px-4 py-3">JobID</th>
                  <th class="px-4 py-3">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                  <th class="px-4 py-3">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                  <th class="px-4 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="jobListTable" class="divide-y divide-gray-100">
                </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab2" class="hidden space-y-4">
        <h3 class="font-bold text-gray-700 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå / Backup</h3>
        <div id="backupGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          </div>
      </div>

      <div id="tab3" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 p-4">
        </div>

    </main>
  </div>

  <script>
    // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å 'Deploy as Web App' ‡∏Ç‡∏≠‡∏á Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
    const BACKEND_URL = "https://script.google.com/macros/s/YOUR_APPS_SCRIPT_ID/exec";
    
    let currentUser = null;

    function showLoading(show) {
      document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö Google Apps Script (Black)
    async function api(action, data = {}) {
      try {
        const response = await fetch(BACKEND_URL, {
          method: "POST",
          body: JSON.stringify({ action, ...data })
        });
        return await response.json();
      } catch (e) {
        alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        return { success: false };
      }
    }

    async function doLogin() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      if(!u || !p) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

      showLoading(true);
      const res = await api('login', { user: u, pass: p });
      showLoading(false);

      if(res.success) {
        currentUser = res.user;
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('displayUserName').innerText = res.user.name;
        document.getElementById('displayUserRole').innerText = res.user.role;
        loadData();
      } else {
        alert("Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    }

    async function loadData() {
      showLoading(true);
      const res = await api('getInitialData');
      showLoading(false);
      
      if(res.success) {
        renderDashboard(res.jobs);
        renderBackup(res.backup);
        renderLinks(res.links);
      }
    }

    function renderDashboard(jobs) {
      const tbody = document.getElementById('jobListTable');
      tbody.innerHTML = jobs.map(j => `
        <tr class="hover:bg-gray-50 transition">
          <td class="px-4 py-4 font-bold text-pink-600">${j.JobID}</td>
          <td class="px-4 py-4">
            <div class="font-medium text-gray-800">${j.Problem}</div>
            <div class="text-[10px] text-gray-400">${j.JobType}</div>
          </td>
          <td class="px-4 py-4 text-gray-500">${j.Department}</td>
          <td class="px-4 py-4">
            <span class="px-2 py-1 rounded-full text-[10px] font-bold ${getStatusClass(j.Status)}">${j.Status}</span>
          </td>
          <td class="px-4 py-4 text-center">
            <button class="bg-slate-100 hover:bg-pink-100 p-2 rounded-lg text-pink-600 transition">‚öôÔ∏è</button>
          </td>
        </tr>
      `).join('');

      // Update Stats
      document.getElementById('countTotal').innerText = jobs.length;
      document.getElementById('countWaiting').innerText = jobs.filter(x => x.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').length;
      document.getElementById('countPending').innerText = jobs.filter(x => x.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
      document.getElementById('countDone').innerText = jobs.filter(x => x.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;
    }

    function renderBackup(data) {
      const grid = document.getElementById('backupGrid');
      grid.innerHTML = data.map(b => `
        <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex gap-4 items-center">
          <div class="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center text-2xl">üì¶</div>
          <div>
            <p class="font-bold text-gray-800 text-sm">${b.AssetID || 'N/A'}</p>
            <p class="text-xs text-gray-500">${b.‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p>
            <p class="text-[10px] text-indigo-400 font-bold mt-1 uppercase">${b.MaStatus || '‡∏õ‡∏Å‡∏ï‡∏¥'}</p>
          </div>
        </div>
      `).join('');
    }

    function renderLinks(links) {
      const grid = document.getElementById('tab3');
      grid.innerHTML = links.map(l => `
        <a href="${l.URL}" target="_blank" class="bg-white p-6 rounded-3xl shadow-sm border border-gray-50 flex flex-col items-center hover:shadow-md transition transform hover:-translate-y-1">
          <div class="text-4xl mb-3">${l.Linkicon || 'üîó'}</div>
          <span class="text-xs font-bold text-gray-700 text-center">${l.Name}</span>
        </a>
      `).join('');
    }

    function getStatusClass(s) {
      if(s === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô') return 'status-waiting';
      if(s === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return 'status-progress';
      return 'status-done';
    }

    function switchTab(n) {
      [1,2,3].forEach(i => {
        document.getElementById('tab'+i).classList.add('hidden');
        document.getElementById('tabBtn'+i).classList.remove('tab-active');
        document.getElementById('tabBtn'+i).classList.add('text-gray-500');
      });
      document.getElementById('tab'+n).classList.remove('hidden');
      document.getElementById('tabBtn'+n).classList.add('tab-active');
    }

  </script>
</body>
</html>
