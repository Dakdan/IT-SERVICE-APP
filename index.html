<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSM - ‡∏£‡∏û.‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #fdf2f8; min-height: 100vh; }
        .pink-grad { background: linear-gradient(135deg, #be185d 0%, #db2777 100%); }
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:9999; justify-content:center; align-items:center; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card-pro { background: white; border-radius: 1.2rem; border: 1px solid #fce7f3; padding: 1rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body>

    <div id="loader" class="overlay">
        <div class="bg-white p-6 rounded-3xl shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-pink-600 border-t-transparent mb-3"></div>
            <p class="text-pink-600 font-bold text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <header class="pink-grad text-white px-6 py-6 sticky top-0 z-50 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="./‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ .png" class="w-12 h-12 bg-white rounded-full p-1">
                <h1 class="font-bold text-lg leading-tight">‡∏£‡∏û.‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ (ITSM)</h1>
            </div>
            <button onclick="logout()" class="bg-white/20 p-2 rounded-xl">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>

    <nav class="bg-white sticky top-[88px] z-40 border-b border-pink-100 flex max-w-4xl mx-auto">
        <button onclick="switchTab(1)" id="t1" class="flex-1 py-4 text-xs font-bold border-b-4 border-pink-600 text-pink-600">DASHBOARD</button>
        <button onclick="switchTab(2)" id="t2" class="flex-1 py-4 text-xs font-bold border-b-4 border-transparent text-slate-400">MY JOBS</button>
        <button onclick="switchTab(3)" id="t3" class="flex-1 py-4 text-xs font-bold border-b-4 border-transparent text-slate-400">LINK</button>
    </nav>

    <main class="max-w-4xl mx-auto p-4 space-y-4">
        <div id="tab1" class="tab-content active">
            <div id="job-list-dashboard" class="space-y-3"></div>
        </div>
        <div id="tab2" class="tab-content">
            <div id="job-list-myjob" class="space-y-3"></div>
        </div>
        <div id="tab3" class="tab-content grid grid-cols-2 gap-4"></div>
    </main>

    <div id="modal-transfer" class="overlay">
        <div class="bg-white p-6 rounded-[2rem] w-full max-w-sm mx-4">
            <h3 class="font-bold text-pink-600 mb-4">üîÑ ‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</h3>
            <select id="select-staff" class="w-full p-3 bg-slate-50 rounded-xl mb-3 text-sm"></select>
            <textarea id="transfer-reason" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="w-full p-3 bg-slate-50 rounded-xl mb-3 text-sm h-24"></textarea>
            <button id="btn-confirm" class="w-full py-3 pink-grad text-white rounded-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
            <button onclick="closeModal()" class="w-full py-3 text-slate-400 text-xs">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

   <script>
    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
    const API_URL = 'https://script.google.com/macros/s/AKfycbzala43clqUn9Z9ky9BlAhcTq6Ang40koFQDi59q33spvLNQpcEFqc2_PJ-xT5NHx4/exec';
    let store = { AllJobs: [], StaffList: [], SystemLink: [] };
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏≠ Onload)
    const session = localStorage.getItem("it_session");
    if (!session) { 
        window.location.href = "login.html"; 
    }
    const currentUser = JSON.parse(session);

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Loader ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    const toggleLoader = (show) => {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = show ? 'flex' : 'none';
    };

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    async function loadInitialData() {
        toggleLoader(true);
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'getInitialData', 
                    data: { userName: currentUser.UserName } 
                }) 
            });
            const result = await res.json();
            if (result.success) {
                store = result;
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                renderDashboard();
                renderMyJobs();
                renderLinks();
            }
        } catch (e) {
            console.error("Data loading failed", e);
        } finally {
            toggleLoader(false);
        }
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render (‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
    function renderDashboard() {
        const jobs = store.AllJobs || [];
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Counts (‡πÉ‡∏™‡πà‡∏î‡∏±‡∏Å‡πÄ‡∏ú‡∏∑‡πà‡∏≠ ID ‡∏´‡∏≤‡∏¢)
        const updateCount = (id, status) => {
            const el = document.getElementById(id);
            if (el) el.innerText = jobs.filter(j => j.Status === status).length;
        };
        updateCount('count-wait', '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô');
        updateCount('count-doing', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
        updateCount('count-spare', '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà');
        updateCount('count-done', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

        const list = document.getElementById('job-list-dashboard');
        if (!list) return;

        list.innerHTML = jobs.map(j => `
            <div class="card-pro p-4 border-l-4 ${j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'border-pink-500' : 'border-slate-200'} mb-3">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold">${j.JobID}</p>
                        <h3 class="font-bold text-slate-700 text-sm">${j.Problem}</h3>
                        <p class="text-[10px] text-pink-600 mt-1">üè¢ ${j.Department}</p>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <span class="text-[10px] font-bold px-2 py-1 rounded bg-slate-100 text-slate-600 border">${j.Status}</span>
                        ${j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' && (currentUser.UserTypeID === 'IT' || currentUser.UserTypeID === 'Admin') ? 
                            `<button onclick="handleAction('${j.JobID}', 'accept')" class="bg-pink-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderMyJobs() {
        const myJobs = (store.AllJobs || []).filter(j => j.Owner === currentUser.UserName);
        const list = document.getElementById('job-list-myjob');
        if (!list) return;

        list.innerHTML = myJobs.length ? myJobs.map(j => `
            <div class="card-pro p-4 border-l-4 border-blue-500 mb-3">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold">${j.JobID}</p>
                        <h3 class="font-bold text-slate-700 text-sm">${j.Problem}</h3>
                    </div>
                    <button onclick="openTransferModal('${j.JobID}')" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-[10px] font-bold">‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
        `).join('') : '<p class="text-center text-xs text-slate-400 py-10 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>';
    }

    function renderLinks() {
        const list = document.getElementById('tab3');
        if (!list) return;
        list.innerHTML = (store.SystemLink || []).map(l => `
            <a href="${l.URL}" target="_blank" class="bg-white p-4 rounded-xl flex items-center gap-3 shadow-sm border border-pink-50">
                <span class="text-2xl">${l.Linkicon || 'üîó'}</span>
                <span class="font-bold text-slate-700 text-sm">${l.SystemName || l.Name}</span>
            </a>
        `).join('');
    }

    // 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
    async function handleAction(jobId, type, extra = {}) {
        toggleLoader(true);
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'updateJobStatus', 
                    data: { JobID: jobId, type: type, Owner: currentUser.UserName, ...extra } 
                }) 
            });
            const result = await res.json();
            if (result.success) {
                closeModal('modal-transfer');
                await loadInitialData(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            }
        } catch (e) { alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        toggleLoader(false);
    }

    function openTransferModal(jobId) {
        const select = document.getElementById('select-staff');
        if (select && store.StaffList) {
            select.innerHTML = store.StaffList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }
        document.getElementById('modal-transfer').style.display = 'flex';
        document.getElementById('btn-confirm-transfer').onclick = () => {
            const reason = document.getElementById('transfer-reason').value;
            if (!reason) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
            handleAction(jobId, 'transfer', { NewOwner: select.value, Reason: reason, By: currentUser.UserName });
        };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡∏¥‡∏°
    function switchTab(n) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab' + n).classList.add('active');
        document.querySelectorAll('nav button').forEach((b, i) => {
            const isActive = (i + 1 === n);
            b.classList.toggle('text-pink-600', isActive);
            b.classList.toggle('border-pink-600', isActive);
            b.classList.toggle('text-slate-400', !isActive);
            b.classList.toggle('border-transparent', !isActive);
        });
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function logout() { localStorage.removeItem("it_session"); window.location.href = "login.html"; }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('u-fname').innerText = currentUser.UserName || "";
        document.getElementById('u-type-name').innerText = currentUser.UserTypeName || "";
        loadInitialData();
    });
</script>
</body>
</html>
