<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IT Service System</title>
<style>
body{font-family:Arial;background:#f4f6f9;margin:20px;}
.card{background:white;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,select,textarea{width:100%;padding:8px;margin-top:5px;margin-bottom:10px;}
button{padding:8px 12px;background:#2c7be5;color:white;border:none;border-radius:4px;cursor:pointer;}
button:hover{background:#1a5ed8;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ddd;padding:8px;text-align:left;}
.status{cursor:pointer;color:#2c7be5;font-weight:bold;}
</style>
</head>
<body>

<h2>IT Service / Maintenance System</h2>

<div class="card">
<h3>Create Job</h3>

<label>Job Type</label>
<select id="jobType" onchange="toggleAsset()">
<option value="Service">Service</option>
<option value="Maintenance">Maintenance</option>
<option value="Management">Management</option>
</select>

<div id="assetSection" style="display:none;">
<label>Asset Code (NOID)</label>
<input id="assetCode">
<button onclick="searchAsset()">ค้นหา</button>
<div id="assetInfo"></div>
</div>

<label>Problem</label>
<textarea id="problem"></textarea>

<label>Priority</label>
<select id="priority"></select>

<label>Upload Image</label>
<input type="file" id="file">

<button onclick="createJob()">Create Job</button>

</div>

<div class="card">
<h3>Job List</h3>
<button onclick="loadJobs()">Refresh</button>
<div id="jobTable"></div>
</div>

<script>

// ====== CONFIG ======
const API_URL = "https://script.google.com/macros/s/AKfycbzQ5BqV98wAABriBq6brNLxlrN669aYgIfsAMd3uj0yCEcRj5iOVOKdiDpjr-TL1Fx7fg/exec";
const TOKEN = "IT-SERVICE-2026";
const DRIVE_FOLDER_ID = "https://drive.google.com/drive/folders/1JPMhK_5uitk2kp4f8Nkq3Lc83wrK9az8?usp=sharing";

// ====== INIT ======
window.onload = async function(){
  await loadPriority();
  await loadJobs();
};

// ====== API WRAPPER ======
async function callAPI(action,data={}){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      token:TOKEN,
      action:action,
      ...data
    })
  });
  return await res.json();
}

// ====== PRIORITY ======
async function loadPriority(){
  const data = await callAPI("getPriority");
  const select = document.getElementById("priority");
  select.innerHTML="";
  data.slice(1).forEach(r=>{
    const opt=document.createElement("option");
    opt.value=r[0];
    opt.textContent=r[1];
    select.appendChild(opt);
  });
}

// ====== TOGGLE ASSET ======
function toggleAsset(){
  const type=document.getElementById("jobType").value;
  document.getElementById("assetSection").style.display =
    type==="Maintenance"?"block":"none";
}

// ====== SEARCH ASSET ======
async function searchAsset(){
  const code=document.getElementById("assetCode").value;
  const data=await callAPI("getAsset",{assetCode:code});

  if(!data){
    document.getElementById("assetInfo").innerHTML="ไม่พบข้อมูล";
    return;
  }

  document.getElementById("assetInfo").innerHTML=
    "<b>"+data[0]+"</b><br>"+data[1]+"<br>"+data[2];
}

// ====== FILE TO BASE64 ======
function toBase64(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}

// ====== CREATE JOB ======
async function createJob(){

  const jobType=document.getElementById("jobType").value;
  const assetCode=document.getElementById("assetCode").value;

  if(jobType==="Maintenance" && !assetCode){
    alert("ต้องระบุ AssetCode");
    return;
  }

  const fileInput=document.getElementById("file");
  if(fileInput.files.length>0){
    const base64=await toBase64(fileInput.files[0]);
    await callAPI("uploadFile",{
      base64:base64,
      fileName:fileInput.files[0].name,
      mimeType:fileInput.files[0].type,
      folderId:DRIVE_FOLDER_ID
    });
  }

  await callAPI("createJob",{
    createBy:"USER01",
    jobType:jobType,
    assetCode:assetCode,
    problem:document.getElementById("problem").value,
    priorityId:document.getElementById("priority").value
  });

  alert("สร้างงานเรียบร้อย");
  loadJobs();
}

// ====== LOAD JOBS ======
async function loadJobs(){

  const data=await callAPI("getJobs",{page:1,limit:20});
  let html="<table>";
  html+="<tr><th>ID</th><th>Type</th><th>Priority</th><th>Status</th></tr>";

  data.slice(1).forEach(r=>{
    html+="<tr>";
    html+="<td>"+r[0]+"</td>";
    html+="<td>"+r[3]+"</td>";
    html+="<td>"+r[6]+"</td>";
    html+="<td class='status' onclick=\"updateStatus('"+r[0]+"')\">"+r[7]+"</td>";
    html+="</tr>";
  });

  html+="</table>";
  document.getElementById("jobTable").innerHTML=html;
}

// ====== UPDATE STATUS ======
async function updateStatus(jobId){
  const newStatus=prompt("เปลี่ยนสถานะ:");
  if(!newStatus) return;

  await callAPI("updateStatus",{
    jobId:jobId,
    status:newStatus
  });

  loadJobs();
}

</script>
</body>
</html>
