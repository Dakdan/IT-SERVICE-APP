<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IT Service Management - ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Kanit', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(180deg, #fce7f3 0%, #fdf2f8 30%, #ffffff 100%);
    }
    
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 120px;
      font-weight: 700;
      color: rgba(236, 72, 153, 0.03);
      pointer-events: none;
      white-space: nowrap;
      z-index: 0;
    }
    
    .card-shadow {
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }
    
    .status-waiting {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      animation: pulse 2s infinite;
    }
    
    .status-progress {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }
    
    .status-done {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .overlay {
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.5);
    }
    
    .modal-enter {
      animation: modalIn 0.3s ease-out;
    }
    
    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .tab-active {
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
      color: white;
    }
    
    .priority-high {
      border-left: 4px solid #ef4444;
    }
    
    .priority-medium {
      border-left: 4px solid #f59e0b;
    }
    
    .priority-low {
      border-left: 4px solid #10b981;
    }
    
    .timer-urgent {
      color: #ef4444;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loader {
      border: 3px solid #fce7f3;
      border-top: 3px solid #ec4899;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      .gradient-bg { background: white !important; }
    }
    
    .dropdown-container {
      position: relative;
    }
    
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #fce7f3;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 50;
    }
    
    .dropdown-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .dropdown-item:hover {
      background: #fce7f3;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #ec4899;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full gradient-bg">
  <div class="watermark">
   IT UDON HOSP
  </div><!-- Overlay Loading -->
  <div id="loadingOverlay" class="fixed inset-0 overlay z-50 flex items-center justify-center hidden">
   <div class="bg-white rounded-2xl p-8 card-shadow modal-enter text-center">
    <div class="loader mx-auto mb-4"></div>
    <p id="loadingText" class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
   </div>
  </div><!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
   <div id="toastContent" class="rounded-xl p-4 card-shadow flex items-center gap-3 modal-enter"><span id="toastIcon" class="text-2xl"></span> <span id="toastMessage" class="font-medium"></span>
   </div>
  </div><!-- Login Page -->
  <div id="loginPage" class="min-h-full flex items-center justify-center p-4">
   <div class="w-full max-w-md">
    <div class="bg-white rounded-3xl card-shadow p-8"><!-- Header -->
     <div class="text-center mb-8"><img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 rounded-full card-shadow" onerror="this.style.background='linear-gradient(135deg, #ec4899, #f472b6)'; this.alt='IT';">
      <h1 class="text-xl font-bold text-gray-800">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h1>
      <p class="text-pink-500 font-medium">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</p>
      <p class="text-sm text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
     </div><!-- Login Form -->
     <div id="loginForm">
      <div class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label> <input type="text" id="loginUsername" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100 focus:border-pink-400 transition">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="loginPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100 focus:border-pink-400 transition">
       </div><button onclick="handleLogin()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold"> üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
      <div class="mt-6 text-center space-y-2"><button onclick="showFirstTimeForm()" class="text-pink-500 hover:text-pink-600 font-medium text-sm"> üÜï ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å </button> <span class="mx-2 text-gray-300">|</span> <button onclick="showForgotPassword()" class="text-pink-500 hover:text-pink-600 font-medium text-sm"> üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô </button>
      </div>
     </div><!-- First Time Registration Form -->
     <div id="firstTimeForm" class="hidden">
      <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
      <div class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="regEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (UserPN)</label> <input type="text" id="regUsername" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label> <input type="text" id="regCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div><button onclick="verifyFirstTime()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold"> ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô </button> <button onclick="showLoginForm()" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-200"> ‚Üê ‡∏Å‡∏•‡∏±‡∏ö </button>
      </div>
     </div><!-- Set Password Form -->
     <div id="setPasswordForm" class="hidden">
      <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">üîí ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
      <div class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label> <input type="password" id="newPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="confirmPassword" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div><button onclick="setNewPassword()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô </button>
      </div>
     </div><!-- Forgot Password Form -->
     <div id="forgotPasswordForm" class="hidden">
      <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">üîë ‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <div class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="forgotEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       </div><button onclick="requestPasswordReset()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold"> üìß ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô </button> <button onclick="showLoginForm()" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-200"> ‚Üê ‡∏Å‡∏•‡∏±‡∏ö </button>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Main Application -->
  <div id="mainApp" class="hidden min-h-full"><!-- Header -->
   <header class="bg-white card-shadow sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-4 py-3">
     <div class="flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-4"><img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" alt="Logo" class="w-12 h-12 rounded-full card-shadow" onerror="this.style.background='linear-gradient(135deg, #ec4899, #f472b6)'; this.alt='IT';">
       <div>
        <h1 class="text-lg font-bold text-gray-800">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h1>
        <p class="text-xs text-pink-500">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô: ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</p>
        <p class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
       </div>
      </div>
      <div class="flex items-center gap-4">
       <div class="flex items-center gap-3 bg-pink-50 rounded-full px-4 py-2">
        <div id="userAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-400 to-pink-500 flex items-center justify-center text-white font-bold">
         üë§
        </div>
        <div class="text-right">
         <p id="userName" class="font-semibold text-gray-800 text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
         <p id="userRole" class="text-xs text-pink-500">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
        </div>
       </div><button onclick="handleLogout()" class="bg-red-100 text-red-500 px-4 py-2 rounded-xl font-medium hover:bg-red-200 transition"> üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
     </div>
    </div>
   </header><!-- Tab Navigation -->
   <nav class="max-w-7xl mx-auto px-4 py-4 no-print">
    <div class="flex gap-2 overflow-x-auto pb-2"><button onclick="switchTab(1)" id="tab1Btn" class="tab-active px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition flex items-center gap-2"> üìä Dashboard </button> <button onclick="switchTab(2)" id="tab2Btn" class="bg-white text-gray-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap card-shadow transition flex items-center gap-2"> üîß ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô </button> <button onclick="switchTab(3)" id="tab3Btn" class="bg-white text-gray-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap card-shadow transition flex items-center gap-2"> üîó ‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å </button>
    </div>
   </nav><!-- Tab Content -->
   <main class="max-w-7xl mx-auto px-4 pb-8"><!-- Tab 1: Dashboard -->
    <div id="tab1Content"><!-- Stats Cards -->
     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl card-shadow p-4 text-center">
       <div class="text-3xl mb-2">
        üìã
       </div>
       <p id="statTotal" class="text-2xl font-bold text-gray-800">0</p>
       <p class="text-sm text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-red-400">
       <div class="text-3xl mb-2">
        ‚è≥
       </div>
       <p id="statWaiting" class="text-2xl font-bold text-red-500">0</p>
       <p class="text-sm text-gray-500">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-yellow-400">
       <div class="text-3xl mb-2">
        üîÑ
       </div>
       <p id="statProgress" class="text-2xl font-bold text-yellow-500">0</p>
       <p class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-green-400">
       <div class="text-3xl mb-2">
        ‚úÖ
       </div>
       <p id="statDone" class="text-2xl font-bold text-green-500">0</p>
       <p class="text-sm text-gray-500">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
      </div>
     </div><!-- Job Tickets Table -->
     <div class="bg-white rounded-2xl card-shadow overflow-hidden">
      <div class="bg-gradient-to-r from-pink-500 to-pink-400 text-white px-6 py-4">
       <h2 class="font-bold text-lg flex items-center gap-2">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-pink-50">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">JobID</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠</th>
          <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="jobTicketsList" class="divide-y divide-pink-100"><!-- Dynamic content -->
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Tab 2: My Jobs -->
    <div id="tab2Content" class="hidden"><!-- My Stats -->
     <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-yellow-400">
       <p id="myStatProgress" class="text-2xl font-bold text-yellow-500">0</p>
       <p class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-green-400">
       <p id="myStatDone" class="text-2xl font-bold text-green-500">0</p>
       <p class="text-sm text-gray-500">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-4 text-center border-l-4 border-blue-400">
       <p id="myStatTotal" class="text-2xl font-bold text-blue-500">0</p>
       <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      </div>
     </div><!-- Action Buttons -->
     <div class="flex gap-3 mb-6 flex-wrap"><button onclick="openAddActivityModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2"> ‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° </button>
     </div><!-- My Jobs List -->
     <div class="bg-white rounded-2xl card-shadow overflow-hidden mb-6">
      <div class="bg-gradient-to-r from-pink-500 to-pink-400 text-white px-6 py-4">
       <h2 class="font-bold text-lg">üîß ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2>
      </div>
      <div id="myJobsList" class="p-4 space-y-3"><!-- Dynamic content -->
      </div>
     </div><!-- IT Tickets List -->
     <div class="bg-white rounded-2xl card-shadow overflow-hidden">
      <div class="bg-gradient-to-r from-purple-500 to-purple-400 text-white px-6 py-4">
       <h2 class="font-bold text-lg">üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (IT_Ticket)</h2>
      </div>
      <div id="itTicketsList" class="p-4 space-y-3"><!-- Dynamic content -->
      </div>
     </div>
    </div><!-- Tab 3: External Links -->
    <div id="tab3Content" class="hidden">
     <div class="bg-white rounded-2xl card-shadow overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-500 to-indigo-400 text-white px-6 py-4">
       <h2 class="font-bold text-lg">üîó ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</h2>
      </div>
      <div id="externalLinksList" class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4"><!-- Dynamic content -->
      </div>
     </div>
    </div>
   </main>
  </div><!-- Modal: Job Detail -->
  <div id="jobDetailModal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl card-shadow w-full max-w-2xl max-h-[90%] overflow-y-auto modal-enter">
    <div class="bg-gradient-to-r from-pink-500 to-pink-400 text-white px-6 py-4 sticky top-0">
     <div class="flex justify-between items-center">
      <h2 class="font-bold text-lg">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h2><button onclick="closeModal('jobDetailModal')" class="text-white hover:bg-white/20 rounded-full p-2">‚úï</button>
     </div>
    </div>
    <div class="p-6">
     <div id="jobDetailContent" class="space-y-4"><!-- Dynamic content -->
     </div>
     <div id="jobDetailActions" class="mt-6 flex gap-3 flex-wrap"><!-- Dynamic buttons -->
     </div>
    </div>
   </div>
  </div><!-- Modal: Assign Job -->
  <div id="assignJobModal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl card-shadow w-full max-w-md modal-enter">
    <div class="bg-gradient-to-r from-blue-500 to-blue-400 text-white px-6 py-4">
     <div class="flex justify-between items-center">
      <h2 class="font-bold text-lg">üë• ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><button onclick="closeModal('assignJobModal')" class="text-white hover:bg-white/20 rounded-full p-2">‚úï</button>
     </div>
    </div>
    <div class="p-6"><input type="hidden" id="assignJobId">
     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label> <select id="assignTo" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100"> <!-- Dynamic options --> </select>
     </div><button onclick="submitAssignJob()" class="w-full btn-secondary text-white py-3 rounded-xl font-semibold"> ‚úì ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ </button>
    </div>
   </div>
  </div><!-- Modal: Transfer Job -->
  <div id="transferJobModal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl card-shadow w-full max-w-md modal-enter">
    <div class="bg-gradient-to-r from-orange-500 to-orange-400 text-white px-6 py-4">
     <div class="flex justify-between items-center">
      <h2 class="font-bold text-lg">üîÑ ‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</h2><button onclick="closeModal('transferJobModal')" class="text-white hover:bg-white/20 rounded-full p-2">‚úï</button>
     </div>
    </div>
    <div class="p-6"><input type="hidden" id="transferJobId">
     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ</label> <select id="transferTo" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100"> <!-- Dynamic options --> </select>
     </div>
     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label> <textarea id="transferReason" rows="3" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô"></textarea>
     </div><button onclick="submitTransferJob()" class="w-full btn-warning text-white py-3 rounded-xl font-semibold"> ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô </button>
    </div>
   </div>
  </div><!-- Modal: Add Activity -->
  <div id="addActivityModal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl card-shadow w-full max-w-xl max-h-[90%] overflow-y-auto modal-enter">
    <div class="bg-gradient-to-r from-green-500 to-green-400 text-white px-6 py-4 sticky top-0">
     <div class="flex justify-between items-center">
      <h2 class="font-bold text-lg">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° IT</h2><button onclick="closeModal('addActivityModal')" class="text-white hover:bg-white/20 rounded-full p-2">‚úï</button>
     </div>
    </div>
    <div class="p-6">
     <form id="activityForm" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label> <select id="actJobType" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢</label> <select id="actJobSubType" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ --</option> </select>
      </div>
      <div class="dropdown-container"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label> <input type="text" id="actDepartment" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" autocomplete="off" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       <div id="deptDropdown" class="dropdown-list hidden"></div><input type="hidden" id="actDepartmentId">
      </div>
      <div class="dropdown-container"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label> <input type="text" id="actAsset" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå" autocomplete="off" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100">
       <div id="assetDropdown" class="dropdown-list hidden"></div><input type="hidden" id="actAssetId">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label> <textarea id="actDescription" rows="3" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"></textarea>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label> <select id="actStatus" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100"> <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option> <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option> </select>
      </div><button type="button" onclick="submitActivity()" class="w-full btn-success text-white py-3 rounded-xl font-semibold"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° </button>
     </form>
    </div>
   </div>
  </div><!-- Modal: Complete Job -->
  <div id="completeJobModal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl card-shadow w-full max-w-md modal-enter">
    <div class="bg-gradient-to-r from-green-500 to-green-400 text-white px-6 py-4">
     <div class="flex justify-between items-center">
      <h2 class="font-bold text-lg">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h2><button onclick="closeModal('completeJobModal')" class="text-white hover:bg-white/20 rounded-full p-2">‚úï</button>
     </div>
    </div>
    <div class="p-6"><input type="hidden" id="completeJobId">
     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</label> <textarea id="completeNote" rows="4" class="w-full px-4 py-3 rounded-xl border-2 border-pink-100" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"></textarea>
     </div><button onclick="submitCompleteJob()" class="w-full btn-success text-white py-3 rounded-xl font-semibold"> ‚úì ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à </button>
    </div>
   </div>
  </div>
  <script>
    // ============ Configuration ============
    const SHEET_ID = '1TUcThdPyAqFRwkFg1NTMtwqbFVjrkJXWqYw0AlwwriI';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxF7ImGdY6XqcFZ4zp6wSK4KMWTrkBk_NoMS5TucQ-e46EvvzP9O32hSzaENSqgoe0B/exec';

    // ============ State Management ============
    let currentUser = null;
    let currentTab = 1;
    let jobTickets = [];
    let itTickets = [];
    let itUsers = [];
    let departments = [];
    let assets = [];
    let jobTypes = [];
    let jobSubTypes = [];
    let systemLinks = [];
    let pendingVerification = null;

    // Default config
    const defaultConfig = {
      system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
      hospital_name: '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ',
      primary_color: '#ec4899',
      secondary_color: '#f472b6',
      background_color: '#fce7f3',
      text_color: '#1f2937',
      accent_color: '#6366f1'
    };

    // ============ Element SDK Integration ============
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          // Update UI based on config
          document.querySelectorAll('.system-title').forEach(el => {
            el.textContent = config.system_title || defaultConfig.system_title;
          });
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['system_title', config.system_title || defaultConfig.system_title],
          ['hospital_name', config.hospital_name || defaultConfig.hospital_name]
        ])
      });
    }

    // ============ Utility Functions ============
    function showLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const content = document.getElementById('toastContent');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      const styles = {
        success: { bg: 'bg-green-100 text-green-800', icon: '‚úÖ' },
        error: { bg: 'bg-red-100 text-red-800', icon: '‚ùå' },
        warning: { bg: 'bg-yellow-100 text-yellow-800', icon: '‚ö†Ô∏è' },
        info: { bg: 'bg-blue-100 text-blue-800', icon: '‚ÑπÔ∏è' }
      };

      const style = styles[type] || styles.info;
      content.className = `rounded-xl p-4 card-shadow flex items-center gap-3 modal-enter ${style.bg}`;
      icon.textContent = style.icon;
      msg.textContent = message;

      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('th-TH', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function calculateWaitTime(startDate) {
      if (!startDate) return '-';
      const start = new Date(startDate);
      const now = new Date();
      const diff = now - start;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      if (hours > 24) {
        const days = Math.floor(hours / 24);
        return `${days} ‡∏ß‡∏±‡∏ô ${hours % 24} ‡∏ä‡∏°.`;
      }
      return `${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    // ============ API Functions ============
    async function callApi(action, data = {}) {
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, sheetId: SHEET_ID, ...data })
        });
        
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        return simulateApiResponse(action, data);
      }
    }

    function simulateApiResponse(action, data) {
      switch (action) {
        case 'login':
          if (data.username === 'admin' && data.password === '1234') {
            return {
              success: true,
              user: {
                ITUSERNO: '1',
                USERID: 'admin',
                UserTypeID: 'IT',
                UserTypeName: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà IT',
                UserName: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                UserSname: 'Admin',
                UserNicName: '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
                UserPN: 'admin',
                UserMail: 'admin@hospital.go.th',
                UserPic: ''
              }
            };
          }
          if (data.username === 'boss' && data.password === '1234') {
            return {
              success: true,
              user: {
                ITUSERNO: '2',
                USERID: 'boss',
                UserTypeID: 'Boss',
                UserTypeName: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô',
                UserName: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô IT',
                UserSname: 'Boss',
                UserNicName: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤',
                UserPN: 'boss',
                UserMail: 'boss@hospital.go.th',
                UserPic: ''
              }
            };
          }
          return { success: false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
        
        case 'getJobTickets':
          return {
            success: true,
            data: [
              {
                JobID: 'JOB-2024-001',
                CreateDate: new Date().toISOString(),
                CreateBy: 'user001',
                Source: '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
                JobType: '‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                AssetCode: 'PC-001',
                AssetName: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏ï‡πä‡∏∞',
                Department: '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à 1',
                Problem: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î',
                Priority: '‡∏™‡∏π‡∏á',
                Status: '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
                Owner: '',
                StartTime: '',
                CloseTime: ''
              },
              {
                JobID: 'JOB-2024-002',
                CreateDate: new Date(Date.now() - 86400000).toISOString(),
                CreateBy: 'user002',
                Source: '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
                JobType: '‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°',
                AssetCode: 'PC-002',
                AssetName: '‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ',
                Department: '‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',
                Problem: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Office',
                Priority: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                Owner: 'admin',
                StartTime: new Date(Date.now() - 3600000).toISOString(),
                CloseTime: ''
              },
              {
                JobID: 'JOB-2024-003',
                CreateDate: new Date(Date.now() - 172800000).toISOString(),
                CreateBy: 'user003',
                Source: '‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô',
                JobType: '‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                AssetCode: 'PR-001',
                AssetName: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå HP',
                Department: '‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤',
                Problem: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å',
                Priority: '‡∏ï‡πà‡∏≥',
                Status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                Owner: 'admin',
                StartTime: new Date(Date.now() - 172800000).toISOString(),
                CloseTime: new Date(Date.now() - 86400000).toISOString()
              }
            ]
          };
        
        case 'getITUsers':
          return {
            success: true,
            data: [
              { ITUSERNO: '1', UserName: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', UserPN: 'admin', UserTypeID: 'IT' },
              { ITUSERNO: '2', UserName: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô IT', UserPN: 'boss', UserTypeID: 'Boss' },
              { ITUSERNO: '3', UserName: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ 1', UserPN: 'tech1', UserTypeID: 'IT' },
              { ITUSERNO: '4', UserName: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ 2', UserPN: 'tech2', UserTypeID: 'IT' }
            ]
          };
        
        case 'getDepartments':
          return {
            success: true,
            data: [
              { DeptID: '1', Note3: '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à 1' },
              { DeptID: '2', Note3: '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à 2' },
              { DeptID: '3', Note3: '‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô' },
              { DeptID: '4', Note3: '‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤' },
              { DeptID: '5', Note3: '‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î' },
              { DeptID: '6', Note3: '‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô 1' },
              { DeptID: '7', Note3: '‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô 2' },
              { DeptID: '8', Note3: '‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô' }
            ]
          };
        
        case 'getAssets':
          return {
            success: true,
            data: [
              { AssetID: 'PC-001', AssetName: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏ï‡πä‡∏∞ Dell' },
              { AssetID: 'PC-002', AssetName: '‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ Lenovo' },
              { AssetID: 'PR-001', AssetName: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå HP LaserJet' },
              { AssetID: 'PR-002', AssetName: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Epson' },
              { AssetID: 'NW-001', AssetName: 'Switch Cisco' },
              { AssetID: 'NW-002', AssetName: 'Access Point' }
            ]
          };
        
        case 'getJobTypes':
          return {
            success: true,
            data: [
              { TypeID: '1', TypeName: '‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå' },
              { TypeID: '2', TypeName: '‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°' },
              { TypeID: '3', TypeName: '‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå' },
              { TypeID: '4', TypeName: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢' },
              { TypeID: '5', TypeName: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
            ]
          };
        
        case 'getJobSubTypes':
          return {
            success: true,
            data: [
              { SubTypeID: '1', TypeID: '1', SubTypeName: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' },
              { SubTypeID: '2', TypeID: '1', SubTypeName: '‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£' },
              { SubTypeID: '3', TypeID: '2', SubTypeName: 'Office 365' },
              { SubTypeID: '4', TypeID: '2', SubTypeName: '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á' },
              { SubTypeID: '5', TypeID: '3', SubTypeName: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏∂‡∏Å' },
              { SubTypeID: '6', TypeID: '3', SubTypeName: '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå' }
            ]
          };
        
        case 'getSystemLinks':
          return {
            success: true,
            data: [
              { LinkID: '1', Name: 'HOSxP', URL: 'http://hosxp.hospital.go.th', RoleAllow: 'ALL', Active: 'Y', Linkicon: 'üè•' },
              { LinkID: '2', Name: 'E-claim', URL: 'http://eclaim.nhso.go.th', RoleAllow: 'ALL', Active: 'Y', Linkicon: 'üìã' },
              { LinkID: '3', Name: 'MOPH IC', URL: 'http://mophic.moph.go.th', RoleAllow: 'ALL', Active: 'Y', Linkicon: 'üìä' },
              { LinkID: '4', Name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', URL: 'http://hr.hospital.go.th', RoleAllow: 'IT,Boss', Active: 'Y', Linkicon: 'üë•' },
              { LinkID: '5', Name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏', URL: 'http://supply.hospital.go.th', RoleAllow: 'ALL', Active: 'Y', Linkicon: 'üì¶' },
              { LinkID: '6', Name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', URL: 'http://finance.hospital.go.th', RoleAllow: 'Boss', Active: 'Y', Linkicon: 'üí∞' }
            ]
          };
        
        case 'getITTickets':
          return {
            success: true,
            data: [
              {
                TicketID: 'IT-2024-001',
                JobType: '‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                SubType: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
                Department: '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à 1',
                Asset: 'PC-001',
                Description: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô RAM 8GB',
                Status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                CreatedBy: 'admin',
                CreatedDate: new Date(Date.now() - 86400000).toISOString()
              }
            ]
          };
        
        default:
          return { success: true };
      }
    }

    // ============ Authentication Functions ============
    function showLoginForm() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('firstTimeForm').classList.add('hidden');
      document.getElementById('setPasswordForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
    }

    function showFirstTimeForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('firstTimeForm').classList.remove('hidden');
    }

    function showForgotPassword() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
    }

    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');

      try {
        const result = await callApi('login', { username, password });

        if (result.success) {
          currentUser = result.user;
          sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          await callApi('addLog', {
            action: 'LOGIN',
            email: currentUser.UserMail,
            status: 'SUCCESS',
            message: `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentUser.UserName}`
          });

          hideLoading();
          showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.UserName}`, 'success');
          showMainApp();
        } else {
          hideLoading();
          showToast(result.message || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
      }
    }

    async function verifyFirstTime() {
      const email = document.getElementById('regEmail').value.trim();
      const username = document.getElementById('regUsername').value.trim();
      const code = document.getElementById('regCode').value.trim();

      if (!email || !username || !code) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');

      try {
        const result = await callApi('verifyFirstTime', { email, username, code });

        if (result.success) {
          pendingVerification = { email, username };
          hideLoading();
          showToast('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'success');
          
          document.getElementById('firstTimeForm').classList.add('hidden');
          document.getElementById('setPasswordForm').classList.remove('hidden');
        } else {
          hideLoading();
          showToast(result.message || '‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        }
      } catch (error) {
        hideLoading();
        pendingVerification = { email, username };
        showToast('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        document.getElementById('firstTimeForm').classList.add('hidden');
        document.getElementById('setPasswordForm').classList.remove('hidden');
      }
    }

    async function setNewPassword() {
      const newPw = document.getElementById('newPassword').value;
      const confirmPw = document.getElementById('confirmPassword').value;

      if (!newPw || !confirmPw) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'warning');
        return;
      }

      if (newPw !== confirmPw) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
        return;
      }

      if (newPw.length < 4) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...');

      try {
        await callApi('setPassword', { 
          email: pendingVerification.email, 
          username: pendingVerification.username,
          password: newPw 
        });

        hideLoading();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'success');
        showLoginForm();
        
        document.getElementById('loginUsername').value = pendingVerification.username;
        pendingVerification = null;
      } catch (error) {
        hideLoading();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        showLoginForm();
      }
    }

    async function requestPasswordReset() {
      const email = document.getElementById('forgotEmail').value.trim();

      if (!email) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...');

      try {
        await callApi('requestPasswordReset', { email });
        
        await callApi('addLog', {
          action: 'PASSWORD_RESET_REQUEST',
          email: email,
          status: 'SUCCESS',
          message: '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'
        });

        hideLoading();
        showToast('‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        showLoginForm();
      } catch (error) {
        hideLoading();
        showToast('‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß (Demo)', 'success');
        showLoginForm();
      }
    }

    function handleLogout() {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');
      
      callApi('addLog', {
        action: 'LOGOUT',
        email: currentUser?.UserMail || '',
        status: 'SUCCESS',
        message: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'
      }).finally(() => {
        sessionStorage.removeItem('currentUser');
        currentUser = null;
        hideLoading();
        showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      });
    }

    // ============ Main App Functions ============
    async function showMainApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      document.getElementById('userName').textContent = currentUser.UserName;
      document.getElementById('userRole').textContent = currentUser.UserTypeName;
      
      if (currentUser.UserPic) {
        document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.UserPic}" class="w-full h-full rounded-full object-cover" onerror="this.parentElement.innerHTML='üë§'">`;
      }

      await loadAllData();
    }

    async function loadAllData() {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

      try {
        const [tickets, users, depts, assetData, types, subTypes, links, itTix] = await Promise.all([
          callApi('getJobTickets'),
          callApi('getITUsers'),
          callApi('getDepartments'),
          callApi('getAssets'),
          callApi('getJobTypes'),
          callApi('getJobSubTypes'),
          callApi('getSystemLinks'),
          callApi('getITTickets')
        ]);

        if (tickets.success) jobTickets = tickets.data || [];
        if (users.success) itUsers = users.data || [];
        if (depts.success) departments = depts.data || [];
        if (assetData.success) assets = assetData.data || [];
        if (types.success) jobTypes = types.data || [];
        if (subTypes.success) jobSubTypes = subTypes.data || [];
        if (links.success) systemLinks = links.data || [];
        if (itTix.success) itTickets = itTix.data || [];

        renderDashboard();
        renderMyJobs();
        renderExternalLinks();
        populateDropdowns();

        hideLoading();
      } catch (error) {
        hideLoading();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      }
    }

    function switchTab(tabNum) {
      currentTab = tabNum;
      
      ['tab1Btn', 'tab2Btn', 'tab3Btn'].forEach((id, idx) => {
        const btn = document.getElementById(id);
        if (idx + 1 === tabNum) {
          btn.classList.add('tab-active');
          btn.classList.remove('bg-white', 'text-gray-600', 'card-shadow');
        } else {
          btn.classList.remove('tab-active');
          btn.classList.add('bg-white', 'text-gray-600', 'card-shadow');
        }
      });

      document.getElementById('tab1Content').classList.toggle('hidden', tabNum !== 1);
      document.getElementById('tab2Content').classList.toggle('hidden', tabNum !== 2);
      document.getElementById('tab3Content').classList.toggle('hidden', tabNum !== 3);
    }

    // ============ Render Functions ============
    function renderDashboard() {
      const total = jobTickets.length;
      const waiting = jobTickets.filter(j => j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').length;
      const progress = jobTickets.filter(j => j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
      const done = jobTickets.filter(j => j.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statWaiting').textContent = waiting;
      document.getElementById('statProgress').textContent = progress;
      document.getElementById('statDone').textContent = done;

      const priorityOrder = { '‡∏™‡∏π‡∏á': 1, '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 2, '‡∏ï‡πà‡∏≥': 3 };
      const statusOrder = { '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô': 1, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 2, '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': 3 };

      const sorted = [...jobTickets].sort((a, b) => {
        if (statusOrder[a.Status] !== statusOrder[b.Status]) {
          return statusOrder[a.Status] - statusOrder[b.Status];
        }
        return (priorityOrder[a.Priority] || 4) - (priorityOrder[b.Priority] || 4);
      });

      const tbody = document.getElementById('jobTicketsList');
      tbody.innerHTML = sorted.map(job => {
        const priorityClass = job.Priority === '‡∏™‡∏π‡∏á' ? 'priority-high' : 
                              job.Priority === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'priority-medium' : 'priority-low';
        const statusClass = job.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'status-waiting' :
                            job.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'status-progress' : 'status-done';
        const isUrgent = job.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' && job.Priority === '‡∏™‡∏π‡∏á';

        return `
          <tr class="${priorityClass} hover:bg-pink-50 transition cursor-pointer" onclick="openJobDetail('${job.JobID}')">
            <td class="px-4 py-3 font-medium text-pink-600">${job.JobID}</td>
            <td class="px-4 py-3 text-sm">${formatDate(job.CreateDate)}</td>
            <td class="px-4 py-3 text-sm">${job.JobType}</td>
            <td class="px-4 py-3 text-sm max-w-xs truncate">${job.Problem}</td>
            <td class="px-4 py-3 text-sm">${job.Department}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium ${
                job.Priority === '‡∏™‡∏π‡∏á' ? 'bg-red-100 text-red-700' :
                job.Priority === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'
              }">${job.Priority}</span>
            </td>
            <td class="px-4 py-3">
              <span class="px-3 py-1 rounded-full text-xs font-medium text-white ${statusClass}">${job.Status}</span>
            </td>
            <td class="px-4 py-3 text-sm ${isUrgent ? 'timer-urgent font-bold' : ''}">
              ${job.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? calculateWaitTime(job.CreateDate) : '-'}
            </td>
            <td class="px-4 py-3 text-center">
              <button onclick="event.stopPropagation(); openJobDetail('${job.JobID}')" class="text-pink-500 hover:text-pink-700">
                üëÅÔ∏è
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderMyJobs() {
      const myJobs = jobTickets.filter(j => j.Owner === currentUser?.UserPN);
      
      const myProgress = myJobs.filter(j => j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
      const myDone = myJobs.filter(j => j.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;

      document.getElementById('myStatProgress').textContent = myProgress;
      document.getElementById('myStatDone').textContent = myDone;
      document.getElementById('myStatTotal').textContent = myJobs.length;

      const myJobsList = document.getElementById('myJobsList');
      if (myJobs.length === 0) {
        myJobsList.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>';
      } else {
        myJobsList.innerHTML = myJobs.map(job => `
          <div class="bg-pink-50 rounded-xl p-4 hover:bg-pink-100 transition cursor-pointer ${
            job.Priority === '‡∏™‡∏π‡∏á' ? 'border-l-4 border-red-400' : ''
          }" onclick="openJobDetail('${job.JobID}')">
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-pink-600">${job.JobID}</span>
              <span class="px-3 py-1 rounded-full text-xs font-medium text-white ${
                job.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'status-progress' : 'status-done'
              }">${job.Status}</span>
            </div>
            <p class="text-sm text-gray-700 mb-1"><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${job.JobType}</p>
            <p class="text-sm text-gray-700 mb-1"><strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${job.Problem}</p>
            <p class="text-sm text-gray-500"><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${job.Department}</p>
          </div>
        `).join('');
      }

      const itTicketsList = document.getElementById('itTicketsList');
      if (itTickets.length === 0) {
        itTicketsList.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
      } else {
        itTicketsList.innerHTML = itTickets.map(ticket => `
          <div class="bg-purple-50 rounded-xl p-4">
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-purple-600">${ticket.TicketID}</span>
              <span class="text-xs text-gray-500">${formatDate(ticket.CreatedDate)}</span>
            </div>
            <p class="text-sm text-gray-700"><strong>${ticket.JobType}</strong> - ${ticket.SubType}</p>
            <p class="text-sm text-gray-600">${ticket.Description}</p>
            <p class="text-xs text-gray-500 mt-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${ticket.Department} | ‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå: ${ticket.Asset}</p>
          </div>
        `).join('');
      }
    }

    function renderExternalLinks() {
      const container = document.getElementById('externalLinksList');
      
      const allowedLinks = systemLinks.filter(link => {
        if (link.Active !== 'Y') return false;
        if (link.RoleAllow === 'ALL') return true;
        return link.RoleAllow.split(',').includes(currentUser?.UserTypeID);
      });

      if (allowedLinks.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8 col-span-full">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</p>';
        return;
      }

      container.innerHTML = allowedLinks.map(link => `
        <a href="${link.URL}" target="_blank" rel="noopener noreferrer" 
           class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 text-center hover:shadow-lg transition transform hover:-translate-y-1"
           onclick="showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î ${link.Name}...', 'info')">
          <div class="text-4xl mb-3">${link.Linkicon || 'üîó'}</div>
          <p class="font-semibold text-gray-800">${link.Name}</p>
        </a>
      `).join('');
    }

    function populateDropdowns() {
      const jobTypeSelect = document.getElementById('actJobType');
      jobTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>' +
        jobTypes.map(t => `<option value="${t.TypeID}">${t.TypeName}</option>`).join('');

      const itUserOptions = itUsers
        .filter(u => u.UserTypeID === 'IT' && u.UserPN !== currentUser?.UserPN)
        .map(u => `<option value="${u.UserPN}">${u.UserName}</option>`)
        .join('');

      document.getElementById('assignTo').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>' + itUserOptions;
      document.getElementById('transferTo').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>' + itUserOptions;
    }

    // ============ Job Type Change Handler ============
    document.getElementById('actJobType')?.addEventListener('change', function() {
      const typeId = this.value;
      const subTypeSelect = document.getElementById('actJobSubType');
      
      const filteredSubTypes = jobSubTypes.filter(st => st.TypeID === typeId);
      subTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ --</option>' +
        filteredSubTypes.map(st => `<option value="${st.SubTypeID}">${st.SubTypeName}</option>`).join('');
    });

    // ============ Autocomplete for Department ============
    const deptInput = document.getElementById('actDepartment');
    const deptDropdown = document.getElementById('deptDropdown');

    deptInput?.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      if (query.length < 1) {
        deptDropdown.classList.add('hidden');
        return;
      }

      const filtered = departments.filter(d => 
        d.Note3?.toLowerCase().includes(query)
      ).slice(0, 10);

      if (filtered.length === 0) {
        deptDropdown.classList.add('hidden');
        return;
      }

      deptDropdown.innerHTML = filtered.map(d => `
        <div class="dropdown-item" onclick="selectDepartment('${d.DeptID}', '${d.Note3}')">${d.Note3}</div>
      `).join('');
      deptDropdown.classList.remove('hidden');
    });

    deptInput?.addEventListener('blur', () => setTimeout(() => deptDropdown?.classList.add('hidden'), 200));

    function selectDepartment(id, name) {
      document.getElementById('actDepartment').value = name;
      document.getElementById('actDepartmentId').value = id;
      document.getElementById('deptDropdown').classList.add('hidden');
    }

    // ============ Autocomplete for Asset ============
    const assetInput = document.getElementById('actAsset');
    const assetDropdown = document.getElementById('assetDropdown');

    assetInput?.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      if (query.length < 1) {
        assetDropdown.classList.add('hidden');
        return;
      }

      const filtered = assets.filter(a => 
        a.AssetID?.toLowerCase().includes(query) || 
        a.AssetName?.toLowerCase().includes(query)
      ).slice(0, 10);

      if (filtered.length === 0) {
        assetDropdown.classList.add('hidden');
        return;
      }

      assetDropdown.innerHTML = filtered.map(a => `
        <div class="dropdown-item" onclick="selectAsset('${a.AssetID}', '${a.AssetName}')">${a.AssetID} - ${a.AssetName}</div>
      `).join('');
      assetDropdown.classList.remove('hidden');
    });

    assetInput?.addEventListener('blur', () => setTimeout(() => assetDropdown?.classList.add('hidden'), 200));

    function selectAsset(id, name) {
      document.getElementById('actAsset').value = `${id} - ${name}`;
      document.getElementById('actAssetId').value = id;
      document.getElementById('assetDropdown').classList.add('hidden');
    }

    window.selectDepartment = selectDepartment;
    window.selectAsset = selectAsset;

    // ============ Modal Functions ============
    function openJobDetail(jobId) {
      const job = jobTickets.find(j => j.JobID === jobId);
      if (!job) return;

      const content = document.getElementById('jobDetailContent');
      content.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</p>
            <p class="font-bold text-pink-600">${job.JobID}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</p>
            <p class="font-medium">${formatDate(job.CreateDate)}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</p>
            <p class="font-medium">${job.JobType}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</p>
            <p class="font-medium">${job.Source}</p>
          </div>
          <div class="col-span-2">
            <p class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</p>
            <p class="font-medium bg-gray-50 p-3 rounded-lg">${job.Problem}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</p>
            <p class="font-medium">${job.Department}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</p>
            <p class="font-medium">${job.AssetCode} - ${job.AssetName}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${
              job.Priority === '‡∏™‡∏π‡∏á' ? 'bg-red-100 text-red-700' :
              job.Priority === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'
            }">${job.Priority}</span>
          </div>
          <div>
            <p class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
            <span class="px-3 py-1 rounded-full text-sm font-medium text-white ${
              job.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'status-waiting' :
              job.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'status-progress' : 'status-done'
            }">${job.Status}</span>
          </div>
          ${job.Owner ? `
          <div>
            <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
            <p class="font-medium">${itUsers.find(u => u.UserPN === job.Owner)?.UserName || job.Owner}</p>
          </div>
          ` : ''}
          ${job.StartTime ? `
          <div>
            <p class="text-sm text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
            <p class="font-medium">${formatDate(job.StartTime)}</p>
          </div>
          ` : ''}
          ${job.CloseTime ? `
          <div>
            <p class="text-sm text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</p>
            <p class="font-medium">${formatDate(job.CloseTime)}</p>
          </div>
          ` : ''}
        </div>
      `;

      const actions = document.getElementById('jobDetailActions');
      let buttons = [];

      if (job.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô') {
        if (currentUser?.UserTypeID === 'IT') {
          buttons.push(`<button onclick="acceptJob('${job.JobID}')" class="btn-success text-white px-6 py-2 rounded-xl font-medium">‚úì ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`);
        }
        if (currentUser?.UserTypeID === 'Boss') {
          buttons.push(`<button onclick="openAssignModal('${job.JobID}')" class="btn-secondary text-white px-6 py-2 rounded-xl font-medium">üë• ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>`);
        }
      }

      if (job.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && job.Owner === currentUser?.UserPN) {
        buttons.push(`<button onclick="openCompleteModal('${job.JobID}')" class="btn-success text-white px-6 py-2 rounded-xl font-medium">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>`);
        buttons.push(`<button onclick="openTransferModal('${job.JobID}')" class="btn-warning text-white px-6 py-2 rounded-xl font-medium">üîÑ ‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</button>`);
      }

      buttons.push(`<button onclick="closeModal('jobDetailModal')" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-xl font-medium">‡∏õ‡∏¥‡∏î</button>`);

      actions.innerHTML = buttons.join('');
      openModal('jobDetailModal');
    }

    window.openJobDetail = openJobDetail;

    async function acceptJob(jobId) {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô...');
      
      try {
        await callApi('updateJobTicket', {
          jobId,
          updates: {
            Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
            Owner: currentUser.UserPN,
            StartTime: new Date().toISOString()
          }
        });

        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
          job.Owner = currentUser.UserPN;
          job.StartTime = new Date().toISOString();
        }

        hideLoading();
        closeModal('jobDetailModal');
        showToast('‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        renderDashboard();
        renderMyJobs();
      } catch (error) {
        hideLoading();
        showToast('‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        
        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
          job.Owner = currentUser.UserPN;
          job.StartTime = new Date().toISOString();
        }
        closeModal('jobDetailModal');
        renderDashboard();
        renderMyJobs();
      }
    }

    window.acceptJob = acceptJob;

    function openAssignModal(jobId) {
      document.getElementById('assignJobId').value = jobId;
      closeModal('jobDetailModal');
      openModal('assignJobModal');
    }

    window.openAssignModal = openAssignModal;

    async function submitAssignJob() {
      const jobId = document.getElementById('assignJobId').value;
      const assignTo = document.getElementById('assignTo').value;

      if (!assignTo) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');

      try {
        await callApi('updateJobTicket', {
          jobId,
          updates: {
            Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
            Owner: assignTo,
            StartTime: new Date().toISOString()
          }
        });

        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
          job.Owner = assignTo;
          job.StartTime = new Date().toISOString();
        }

        hideLoading();
        closeModal('assignJobModal');
        showToast('‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        renderDashboard();
      } catch (error) {
        hideLoading();
        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
          job.Owner = assignTo;
          job.StartTime = new Date().toISOString();
        }
        closeModal('assignJobModal');
        showToast('‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        renderDashboard();
      }
    }

    window.submitAssignJob = submitAssignJob;

    function openTransferModal(jobId) {
      document.getElementById('transferJobId').value = jobId;
      closeModal('jobDetailModal');
      openModal('transferJobModal');
    }

    window.openTransferModal = openTransferModal;

    async function submitTransferJob() {
      const jobId = document.getElementById('transferJobId').value;
      const transferTo = document.getElementById('transferTo').value;
      const reason = document.getElementById('transferReason').value;

      if (!transferTo) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô...');

      try {
        await callApi('updateJobTicket', {
          jobId,
          updates: { Owner: transferTo, RiskNote: reason }
        });

        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Owner = transferTo;
          job.RiskNote = reason;
        }

        hideLoading();
        closeModal('transferJobModal');
        showToast('‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        renderDashboard();
        renderMyJobs();
      } catch (error) {
        hideLoading();
        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Owner = transferTo;
        }
        closeModal('transferJobModal');
        showToast('‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        renderDashboard();
        renderMyJobs();
      }
    }

    window.submitTransferJob = submitTransferJob;

    function openCompleteModal(jobId) {
      document.getElementById('completeJobId').value = jobId;
      closeModal('jobDetailModal');
      openModal('completeJobModal');
    }

    window.openCompleteModal = openCompleteModal;

    async function submitCompleteJob() {
      const jobId = document.getElementById('completeJobId').value;
      const note = document.getElementById('completeNote').value;

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

      try {
        await callApi('updateJobTicket', {
          jobId,
          updates: {
            Status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
            CloseTime: new Date().toISOString(),
            RiskNote: note
          }
        });

        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
          job.CloseTime = new Date().toISOString();
          job.RiskNote = note;
        }

        hideLoading();
        closeModal('completeJobModal');
        showToast('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        renderDashboard();
        renderMyJobs();
      } catch (error) {
        hideLoading();
        const job = jobTickets.find(j => j.JobID === jobId);
        if (job) {
          job.Status = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
          job.CloseTime = new Date().toISOString();
        }
        closeModal('completeJobModal');
        showToast('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        renderDashboard();
        renderMyJobs();
      }
    }

    window.submitCompleteJob = submitCompleteJob;

    function openAddActivityModal() {
      document.getElementById('activityForm').reset();
      document.getElementById('actDepartmentId').value = '';
      document.getElementById('actAssetId').value = '';
      openModal('addActivityModal');
    }

    window.openAddActivityModal = openAddActivityModal;

    async function submitActivity() {
      const jobType = document.getElementById('actJobType');
      const subType = document.getElementById('actJobSubType');
      const dept = document.getElementById('actDepartment').value;
      const asset = document.getElementById('actAsset').value;
      const desc = document.getElementById('actDescription').value;
      const status = document.getElementById('actStatus').value;

      if (!jobType.value) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô', 'warning');
        return;
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

      const newTicket = {
        TicketID: 'IT-' + Date.now(),
        JobType: jobType.options[jobType.selectedIndex].text,
        SubType: subType.options[subType.selectedIndex]?.text || '-',
        Department: dept,
        Asset: document.getElementById('actAssetId').value || asset,
        Description: desc,
        Status: status,
        CreatedBy: currentUser.UserPN,
        CreatedDate: new Date().toISOString()
      };

      try {
        await callApi('addITTicket', newTicket);
        itTickets.unshift(newTicket);
        
        hideLoading();
        closeModal('addActivityModal');
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        renderMyJobs();
      } catch (error) {
        hideLoading();
        itTickets.unshift(newTicket);
        closeModal('addActivityModal');
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Demo)', 'success');
        renderMyJobs();
      }
    }

    window.submitActivity = submitActivity;

    // ============ Initialization ============
    document.addEventListener('DOMContentLoaded', () => {
      const savedUser = sessionStorage.getItem('currentUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          showMainApp();
        } catch (e) {
          sessionStorage.removeItem('currentUser');
        }
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cb603d85332a1b4',t:'MTc3MDY2Nzg3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
