<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Service Management - ‡∏£‡∏û.‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #fdf2f8; position: relative; }
        body::before { content: "IT UDON HOSP"; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 8rem; color: rgba(0,0,0,0.03); font-weight: 900; pointer-events: none; z-index: -1; }
        .pink-grad { background: linear-gradient(135deg, #be185d 0%, #db2777 100%); }
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:9999; justify-content:center; align-items:center; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card-pro { background: white; border-radius: 1.2rem; border: 1px solid #fce7f3; transition: 0.3s; cursor: pointer; }
        .card-pro:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(190, 24, 93, 0.1); }
        .status-pulse { animation: pulse-pink 2s infinite; }
        @keyframes pulse-pink { 0% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(219, 39, 119, 0); } 100% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0); } }
    </style>
</head>
<body class="pb-10">

    <div id="loader" class="overlay"><div class="bg-white p-6 rounded-3xl shadow-xl flex flex-col items-center"><div class="animate-spin rounded-full h-10 w-10 border-4 border-pink-600 border-t-transparent mb-3"></div><p class="text-pink-600 font-bold text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p></div></div>

    <header class="pink-grad text-white px-6 py-6 sticky top-0 z-50 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/MOPH_Thailand_Logo.svg/1024px-MOPH_Thailand_Logo.svg.png" class="w-12 h-12 bg-white rounded-full p-1">
                <div>
                    <h1 class="font-bold text-lg leading-tight">‡∏£‡∏û.‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ (ITSM)</h1>
                    <p class="text-[10px] opacity-80">‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p id="u-fname" class="text-xs font-bold leading-none"></p>
                    <p id="u-type-name" class="text-[9px] opacity-70"></p>
                </div>
                <button onclick="logout()" class="bg-white/20 p-2 rounded-xl">üö™</button>
            </div>
        </div>
    </header>

    <nav class="bg-white/80 backdrop-blur-md sticky top-[88px] z-40 border-b border-pink-100">
        <div class="max-w-4xl mx-auto flex">
            <button onclick="switchTab(1)" id="t1" class="flex-1 py-4 text-xs font-bold border-b-4 border-pink-600 text-pink-600">DASHBOARD</button>
            <button onclick="switchTab(2)" id="t2" class="flex-1 py-4 text-xs font-bold border-b-4 border-transparent text-slate-400">MY JOBS</button>
            <button onclick="switchTab(3)" id="t3" class="flex-1 py-4 text-xs font-bold border-b-4 border-transparent text-slate-400">SYSTEMLINK</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 mt-4 space-y-6">
        <div id="tab1" class="tab-content active space-y-4">
            <div class="grid grid-cols-5 gap-2">
                <div class="bg-white p-3 rounded-2xl text-center shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">New</p><p id="count-wait" class="text-lg font-black text-pink-600">0</p></div>
                <div class="bg-white p-3 rounded-2xl text-center shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Doing</p><p id="count-doing" class="text-lg font-black text-blue-500">0</p></div>
                <div class="bg-white p-3 rounded-2xl text-center shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Spare</p><p id="count-spare" class="text-lg font-black text-orange-400">0</p></div>
                <div class="bg-white p-3 rounded-2xl text-center shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Done</p><p id="count-done" class="text-lg font-black text-green-500">0</p></div>
                <div class="bg-white p-3 rounded-2xl text-center shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Cancel</p><p id="count-cancel" class="text-lg font-black text-slate-300">0</p></div>
            </div>
            <div id="job-list-dashboard" class="space-y-3"></div>
        </div>

        <div id="tab2" class="tab-content space-y-4">
            <div class="bg-white p-4 rounded-3xl flex justify-between items-center shadow-sm">
                <h2 class="text-pink-600 font-bold">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2>
                <button onclick="openModal('modal-it-ticket')" class="bg-pink-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
            </div>
            <div id="job-list-myjob" class="space-y-3"></div>
        </div>

        <div id="tab3" class="tab-content grid grid-cols-1 sm:grid-cols-2 gap-4" id="external-link-list"></div>
    </main>

    <div id="modal-transfer" class="overlay">
        <div class="bg-white p-6 rounded-[2rem] w-full max-w-sm mx-4">
            <h3 class="font-bold text-pink-600 mb-4">üîÑ ‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô/‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <div class="space-y-3">
                <select id="select-staff" class="w-full p-3 bg-slate-50 rounded-xl border-none outline-pink-500 text-sm"></select>
                <textarea id="transfer-reason" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô..." class="w-full p-3 bg-slate-50 rounded-xl border-none outline-pink-500 text-sm h-24"></textarea>
                <button id="btn-confirm-transfer" class="w-full py-3 pink-grad text-white rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
                <button onclick="closeModal('modal-transfer')" class="w-full py-3 text-slate-400 font-bold text-xs">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzala43clqUn9Z9ky9BlAhcTq6Ang40koFQDi59q33spvLNQpcEFqc2_PJ-xT5NHx4/exec';
        let store = { AllJobs: [], StaffList: [], SystemLink: [] };
        let currentUser = null;

        const Auth = {
            check: () => {
                const s = localStorage.getItem("it_session");
                if (!s) window.location.href = "login.html";
                return JSON.parse(s);
            }
        };

        async function initApp() {
            currentUser = Auth.check();
            if (currentUser) {
                document.getElementById('u-fname').innerText = currentUser.UserName + " " + (currentUser.UserSname || "");
                document.getElementById('u-type-name').innerText = currentUser.UserTypeName || "Staff";
                await loadData();
            }
        }

      // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard ‡πÉ‡∏´‡πâ Status ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î
function renderDashboard() {
    const jobs = store.AllJobs || [];
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Dashboard (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Property ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Google Sheet)
    document.getElementById('count-wait').innerText = jobs.filter(j => j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').length;
    document.getElementById('count-doing').innerText = jobs.filter(j => j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
    document.getElementById('count-done').innerText = jobs.filter(j => j.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;

    const listContainer = document.getElementById('job-list-dashboard');
    listContainer.innerHTML = jobs.map(j => {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusColor = j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'text-pink-600' : (j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'text-blue-500' : 'text-green-500');
        const borderColor = j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'border-pink-500 status-pulse' : 'border-slate-200';

        return `
            <div class="card-pro p-5 border-l-8 ${borderColor} mb-3" onclick="console.log('Clicked Job:', '${j.JobID}')">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold text-slate-500">${j.JobID}</span>
                            <span class="text-[10px] font-bold ${j.Priority === '‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î' ? 'text-red-500' : 'text-orange-400'}">üî• ${j.Priority || '‡∏õ‡∏Å‡∏ï‡∏¥'}</span>
                        </div>
                        <h3 class="font-bold text-slate-700 text-sm mb-1">${j.Problem || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'}</h3>
                        <p class="text-[11px] text-slate-500">üè¢ ${j.Department || '-'}</p>
                    </div>
                    
                    <div class="text-right flex flex-col items-end gap-2">
                        <span class="text-xs font-black uppercase px-3 py-1 rounded-full bg-white border border-slate-100 shadow-sm ${statusColor}">
                            ${j.Status || 'Unknown'}
                        </span>
                        
                        ${(j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' && (currentUser.UserTypeID === 'IT' || currentUser.usertypeid === 'IT')) 
                            ? `<button onclick="event.stopPropagation(); handleJob('${j.JobID}', 'accept')" class="bg-pink-600 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold shadow-pink-200 shadow-lg active:scale-95 transition-all">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` 
                            : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÉ‡∏´‡πâ Alert ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î)
async function handleJob(jobId, type, extra = {}) {
    if (!jobId) return;
    
    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    if (type === 'accept' && !confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ' + jobId + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    showLoading(true);
    const payload = { 
        action: 'updateJobStatus', 
        data: { 
            JobID: jobId, 
            type: type, 
            Owner: currentUser.UserName || currentUser.username, 
            ...extra 
        } 
    };

    try {
        console.log("Sending Payload:", payload);
        const res = await fetch(API_URL, { 
            method: 'POST', 
            mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î no-cors ‡∏ñ‡πâ‡∏≤ Apps Script ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Everyone ‡πÅ‡∏•‡πâ‡∏ß
            body: JSON.stringify(payload) 
        });
        
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ä‡πâ Google Apps Script ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á JSON ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        setTimeout(async () => {
            alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            closeModal('modal-transfer');
            await loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
        }, 1500);

    } catch (e) { 
        console.error("Error in handleJob:", e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    } finally {
        showLoading(false);
    }
}

        function renderDashboard() {
            const jobs = store.AllJobs || [];
            document.getElementById('count-wait').innerText = jobs.filter(j => j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').length;
            document.getElementById('count-doing').innerText = jobs.filter(j => j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
            
            document.getElementById('job-list-dashboard').innerHTML = jobs.sort((a,b) => (a.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? -1 : 1)).map(j => `
                <div class="card-pro p-5 border-l-8 ${j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? 'border-pink-500 status-pulse' : 'border-slate-200'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold">${j.JobID} | ${j.Priority}</p>
                            <h3 class="font-bold text-slate-700">${j.Problem}</h3>
                            <p class="text-[10px] text-pink-600 mt-1">üè¢ ${j.Department}</p>
                        </div>
                        ${j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' ? `<button onclick="handleJob('${j.JobID}', 'accept')" class="bg-pink-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderMyJobs() {
            const myJobs = store.AllJobs.filter(j => j.Owner === currentUser.UserName);
            document.getElementById('job-list-myjob').innerHTML = myJobs.length === 0 ? '<p class="text-center text-slate-400 text-xs py-10 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>' : myJobs.map(j => `
                <div class="card-pro p-5 border-l-8 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold">${j.JobID}</p>
                            <h3 class="font-bold text-slate-700">${j.Problem}</h3>
                        </div>
                        <button onclick="openTransfer('${j.JobID}')" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-[10px] font-bold">‡πÇ‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
            `).join('');
        }

        function populateStaffList() {
            const select = document.getElementById('select-staff');
            select.innerHTML = store.StaffList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        async function handleJob(jobId, type, extra = {}) {
            showLoading(true);
            const data = { JobID: jobId, type: type, Owner: currentUser.UserName, ...extra };
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateJobStatus', data: data }) });
                const result = await res.json();
                if (result.success) { 
                    closeModal('modal-transfer');
                    await loadData(); 
                }
            } catch (e) { alert("Error!"); }
            showLoading(false);
        }

        function openTransfer(jobId) {
            document.getElementById('modal-transfer').style.display = 'flex';
            document.getElementById('btn-confirm-transfer').onclick = () => {
                const reason = document.getElementById('transfer-reason').value;
                const newOwner = document.getElementById('select-staff').value;
                if (!reason) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
                handleJob(jobId, 'transfer', { NewOwner: newOwner, Reason: reason, By: currentUser.UserName });
            };
        }

        function renderSystemLinks() {
            const container = document.getElementById('tab3');
            container.innerHTML = store.SystemLink.map(l => `
                <a href="${l.URL}" target="_blank" class="bg-white p-4 rounded-2xl flex items-center gap-3 shadow-sm border border-pink-50 hover:bg-pink-50">
                    <span class="text-2xl">${l.Linkicon || 'üîó'}</span>
                    <span class="font-bold text-slate-700 text-sm">${l.SystemName || l.Name}</span>
                </a>
            `).join('');
        }

        function switchTab(n) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + n).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => { b.classList.remove('text-pink-600', 'border-pink-600'); b.classList.add('text-slate-400', 'border-transparent'); });
            document.getElementById('t' + n).classList.add('text-pink-600', 'border-pink-600');
        }

        function showLoading(v) { document.getElementById('loader').style.display = v ? 'flex' : 'none'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logout() { localStorage.clear(); window.location.href = "login.html"; }

        window.onload = initApp;
    </script>
</body>
</html>
