<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT UDON HOSP - Service System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #fdf2f8; min-height: 100vh; }
        .pink-grad { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:9999; justify-content:center; align-items:center; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(236, 72, 153, 0.1); }
        .job-card:hover { transform: translateY(-2px); transition: all 0.2s; }
    </style>
</head>
<body class="h-full">
    <div id="loader" class="overlay">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-pink-500 border-t-transparent mb-4"></div>
            <p class="text-pink-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
    </div>

    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 card-shadow border border-pink-100">
            <div class="text-center mb-8">
                <div class="bg-pink-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-inner">üè•</div>
                <h1 class="text-2xl font-bold text-gray-800">IT UDON HOSP</h1>
                <p class="text-pink-400 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1 uppercase">Username (UserPN)</label>
                    <input type="text" id="userpn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="w-full px-5 py-3 mt-1 rounded-xl border border-pink-100 focus:ring-2 focus:ring-pink-400 outline-none transition">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1 uppercase">Password</label>
                    <input type="password" id="userpw" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-5 py-3 mt-1 rounded-xl border border-pink-100 focus:ring-2 focus:ring-pink-400 outline-none transition">
                </div>
                <button onclick="handleLogin()" class="w-full pink-grad text-white py-4 rounded-xl font-bold shadow-lg hover:opacity-90 transition transform active:scale-95 mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p class="text-center text-[10px] text-gray-400">Copyright ¬© 2024 IT Udon Thani Hospital</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="pink-grad text-white p-4 sticky top-0 z-50 shadow-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white text-pink-500 p-2 rounded-lg font-bold shadow-sm">IT</div>
                    <div>
                        <h2 class="font-bold leading-none text-sm">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h2>
                        <p class="text-[10px] opacity-90">IT Service Management System</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p id="u-name" class="text-xs font-bold"></p>
                        <p id="u-role" class="text-[9px] bg-white/20 px-2 rounded inline-block"></p>
                    </div>
                    <button onclick="logout()" class="bg-white/20 p-2 rounded-full hover:bg-white/40 transition">üö™</button>
                </div>
            </div>
        </header>

        <nav class="bg-white border-b sticky top-[64px] z-40 shadow-sm">
            <div class="max-w-7xl mx-auto flex">
                <button onclick="switchTab(1)" id="t1" class="flex-1 py-4 text-sm font-bold border-b-2 border-pink-500 text-pink-500 transition">Dashboard</button>
                <button onclick="switchTab(2)" id="t2" class="flex-1 py-4 text-sm font-medium text-gray-500 transition">‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-2xl border border-pink-100 shadow-sm">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="statTotal" class="text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100 shadow-sm">
                    <p class="text-[10px] text-red-400 uppercase font-bold">‡∏Ñ‡πâ‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                    <p id="statWait" class="text-2xl font-bold text-red-600">-</p>
                </div>
            </div>

            <div id="tab1" class="tab-content active">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Ticket ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <button onclick="loadMasterData()" class="bg-pink-100 text-pink-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-pink-200 transition">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 uppercase font-bold text-gray-400">
                                <tr>
                                    <th class="p-4">JobID</th>
                                    <th class="p-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏á‡∏≤‡∏ô</th>
                                    <th class="p-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                    <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="job-table" class="divide-y divide-gray-50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab2" class="tab-content grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </main>
    </div>

    <script>
        // API URL ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏
        const API_URL = 'https://script.google.com/macros/s/AKfycbzala43clqUn9Z9ky9BlAhcTq6Ang40koFQDi59q33spvLNQpcEFqc2_PJ-xT5NHx4/exec'; 
        
        let currentUser = null;
        let masterData = {};

        function showLoading(v) { document.getElementById('loader').style.display = v ? 'flex' : 'none'; }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏´‡∏•‡∏±‡∏Å
        async function callAPI(action, data) {
            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, data })
                });
                const result = await response.json();
                showLoading(false);
                return result;
            } catch (e) {
                showLoading(false);
                console.error("API Error:", e);
                alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
            }
        }

        // ‡∏£‡∏∞‡∏ö‡∏ö Login
        async function handleLogin() {
            const user = document.getElementById('userpn').value;
            const pass = document.getElementById('userpw').value;
            
            if(!user || !pass) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å UserPN ‡πÅ‡∏•‡∏∞ Password');

            const res = await callAPI('checkLogin', { user, pass });
            if(res && res.success) {
                currentUser = res.user;
                initApp();
            } else {
                alert(res.message || '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Application ‡∏´‡∏•‡∏±‡∏á Login
        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('u-name').innerText = currentUser.UserName || currentUser.UserPN;
            document.getElementById('u-role').innerText = currentUser.UserTypeName || 'Staff';
            await loadMasterData();
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Google Sheets
        async function loadMasterData() {
            const res = await callAPI('getInitialData', {});
            if(res && res.success) {
                masterData = res;
                renderDashboard();
                renderLinks();
                updateStats();
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
        function renderDashboard() {
            const tbody = document.getElementById('job-table');
            const jobs = masterData.JobTicket || [];
            
            if(jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>';
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            tbody.innerHTML = jobs.reverse().slice(0, 10).map(j => `
                <tr class="hover:bg-pink-50/30 transition job-card">
                    <td class="p-4 font-bold text-pink-600">${j.JobID}</td>
                    <td class="p-4">
                        <div class="font-medium text-gray-700">${j.JobType || '-'}</div>
                        <div class="text-[10px] text-gray-400">${j.JobSubType || ''}</div>
                    </td>
                    <td class="p-4 text-gray-500 max-w-xs truncate">${j.Problem || '-'}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-[9px] font-bold ${j.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                            ${j.Status || '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
        function renderLinks() {
            const container = document.getElementById('tab2');
            const links = masterData.SystemLink || [];
            
            if(links.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏∞‡∏ö‡∏ö</p>';
                return;
            }

            container.innerHTML = links.map(l => `
                <a href="${l.URL}" target="_blank" class="bg-white p-6 rounded-3xl shadow-sm border border-pink-50 flex flex-col items-center hover:scale-105 transition hover:bg-pink-50 group">
                    <div class="text-3xl mb-3 group-hover:scale-110 transition">${l.Linkicon || 'üîó'}</div>
                    <span class="text-xs font-bold text-gray-600 text-center">${l.Name}</span>
                </a>
            `).join('');
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function updateStats() {
            const jobs = masterData.JobTicket || [];
            document.getElementById('statTotal').innerText = jobs.length;
            document.getElementById('statWait').innerText = jobs.filter(j => j.Status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;
        }

        // ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function switchTab(idx) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + idx).classList.add('active');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.replace('text-pink-500', 'text-gray-500');
                b.classList.replace('font-bold', 'font-medium');
                b.classList.remove('border-b-2', 'border-pink-500');
            });
            
            const btn = document.getElementById('t' + idx);
            btn.classList.replace('text-gray-500', 'text-pink-500');
            btn.classList.replace('font-medium', 'font-bold');
            btn.classList.add('border-b-2', 'border-pink-500');
        }

        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function logout() {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) location.reload();
        }
    </script>
</body>
</html>
