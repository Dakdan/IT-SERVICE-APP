<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT UDON HOSP - Master System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --pink-main: #ec4899; }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(180deg, #FFF5F7 0%, #FFFFFF 100%); min-height: 100vh; color: #374151; }
        .pink-grad { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
        .card-custom { background: white; border-radius: 1.5rem; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.05); border: 1px solid rgba(236, 72, 153, 0.1); transition: all 0.3s ease; }
        .card-custom:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.1); }
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(6px); z-index:9999; justify-content:center; align-items:center; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-pill { padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .sla-green { border-left: 4px solid #10b981; }
        .sla-yellow { border-left: 4px solid #f59e0b; }
        .sla-red { border-left: 4px solid #ef4444; }
    </style>
</head>
<body>

    <div id="loader" class="overlay">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-14 w-14 border-4 border-pink-500 border-t-transparent mb-4"></div>
            <p id="loader-text" class="text-pink-600 font-bold tracking-wide">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
        </div>
    </div>

    <div id="main-app" class="">
        <header class="pink-grad text-white p-4 sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://img2.pic.in.th/-227e4f6f84f29f020.png" class="w-12 h-12 bg-white rounded-2xl p-1 shadow-md">
                    <div>
                        <h2 class="font-bold text-lg leading-none">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h2>
                        <p class="text-[10px] opacity-90 uppercase tracking-tighter">IT Service & Maintenance Management</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-white/10 p-1.5 pl-4 rounded-2xl">
                    <div class="text-right">
                        <p id="u-name" class="font-bold text-xs leading-none">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
                        <p id="u-role" class="text-[9px] opacity-80"></p>
                    </div>
                    <img id="u-pic" src="https://www.w3schools.com/howto/img_avatar.png" class="w-10 h-10 rounded-xl border-2 border-white/50 object-cover">
                    <button onclick="logout()" class="p-2 hover:bg-white/20 rounded-xl transition">üö™</button>
                </div>
            </div>
        </header>

        <nav class="bg-white/80 backdrop-blur-md border-b sticky top-[80px] z-40">
            <div class="max-w-7xl mx-auto flex">
                <button onclick="switchTab(1)" id="t1" class="flex-1 py-4 text-sm font-bold border-b-4 border-pink-500 text-pink-500">üìä DASHBOARD</button>
                <button onclick="switchTab(2)" id="t2" class="flex-1 py-4 text-sm font-medium text-gray-400">üõ†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</button>
                <button onclick="switchTab(3)" id="t3" class="flex-1 py-4 text-sm font-medium text-gray-400">üîó ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 lg:p-6 space-y-6">
            
            <div id="tab1" class="tab-content active space-y-6">
                <div id="stats-area" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>

                <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2">
                            <span class="w-2 h-6 pink-grad rounded-full"></span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="loadMasterData()" class="text-xs bg-white border px-4 py-2 rounded-xl hover:bg-pink-50 transition">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-400 text-[10px] uppercase font-bold">
                                <tr>
                                    <th class="p-4 text-left">SLA/JobID</th>
                                    <th class="p-4 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                    <th class="p-4 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                                    <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="job-table-body" class="divide-y divide-gray-50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab2" class="tab-content space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-xl text-gray-800">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h3>
                    <button onclick="openFormModal()" class="pink-grad text-white px-6 py-3 rounded-2xl font-bold shadow-lg flex items-center gap-2">
                        <span>+</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà (IT_TICKET)
                    </button>
                </div>
                <div id="my-work-grid" class="grid md:grid-cols-2 gap-4">
                    </div>
            </div>

            <div id="tab3" class="tab-content grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                </div>

        </main>
    </div>

    <div id="modal-detail" class="overlay">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] overflow-hidden shadow-2xl m-4">
            <div class="pink-grad p-6 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-xl" id="md-job-id">JOB-XXXX</h3>
                    <p class="text-[10px] opacity-80" id="md-timestamp"></p>
                </div>
                <button onclick="closeModal('modal-detail')" class="w-10 h-10 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/40">‚úï</button>
            </div>
            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] uppercase text-gray-400 font-bold block mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                        <p id="md-dept" class="font-bold text-gray-700"></p>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-gray-400 font-bold block mb-1">‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                        <p id="md-asset" class="font-bold text-gray-700"></p>
                    </div>
                </div>
                <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100">
                    <label class="text-[10px] uppercase text-pink-400 font-bold block mb-1">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á/‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
                    <p id="md-problem" class="text-sm text-gray-700 leading-relaxed"></p>
                </div>
                <div id="md-technician-info" class="hidden border-t pt-4">
                    <label class="text-[10px] uppercase text-gray-400 font-bold block mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                    <p id="md-tech-name" class="font-bold text-blue-600"></p>
                </div>
            </div>
            <div id="md-actions" class="p-6 bg-gray-50 flex flex-wrap gap-3 border-t">
                </div>
        </div>
    </div>

    <div id="modal-form" class="overlay">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl m-4">
            <div class="bg-slate-800 p-6 text-white">
                <h3 class="font-bold text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h3>
            </div>
            <div class="p-8 space-y-4">
                <select id="f-type" onchange="updateSubTypes()" class="w-full p-4 rounded-2xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-300"></select>
                <select id="f-sub" class="w-full p-4 rounded-2xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-300"></select>
                <input type="text" id="f-dept" list="dept-list" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full p-4 rounded-2xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-300">
                <input type="text" id="f-asset" list="asset-list" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå..." class="w-full p-4 rounded-2xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-300">
                <textarea id="f-detail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£..." class="w-full p-4 rounded-2xl bg-gray-100 border-none h-32"></textarea>
                
                <div class="flex gap-3">
                    <button onclick="submitITTicket()" class="flex-1 pink-grad text-white py-4 rounded-2xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="closeModal('modal-form')" class="px-6 py-4 rounded-2xl bg-gray-200 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <datalist id="dept-list"></datalist>
    <datalist id="asset-list"></datalist>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzala43clqUn9Z9ky9BlAhcTq6Ang40koFQDi59q33spvLNQpcEFqc2_PJ-xT5NHx4/exec'; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy
        let store = {
            JobTicket: [],
            JobTypeMaster: [],
            JobSubTypeMaster: [],
            Department: [],
            BackupData: [],
            SystemLink: []
        };
        let currentUser = JSON.parse(sessionStorage.getItem('it_user')) || { UserPN: 'IT001', UserName: 'IT Staff', UserTypeName: 'IT', UserTypeID: 'IT' };

        function showLoading(v, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...") {
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loader').style.display = v ? 'flex' : 'none';
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- FETCH DATA ---
        async function loadMasterData() {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...");
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getInitialData' })
                });
                store = await response.json();
                renderDashboard();
                renderLinks();
                setupFormLists();
            } catch (e) {
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        // --- RENDER DASHBOARD ---
        function renderDashboard() {
            const tbody = document.getElementById('job-table-body');
            const statsArea = document.getElementById('stats-area');
            const jobs = store.JobTicket || [];

            // Update Stats
            const wait = jobs.filter(j => j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').length;
            const proc = jobs.filter(j => j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
            const done = jobs.filter(j => j.Status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;

            statsArea.innerHTML = `
                ${renderStatCard("‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", jobs.length, "pink-main")}
                ${renderStatCard("‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô", wait, "orange-500")}
                ${renderStatCard("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", proc, "blue-500")}
                ${renderStatCard("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", done, "green-500")}
            `;

            // Update Table
            tbody.innerHTML = jobs.map(j => `
                <tr class="hover:bg-pink-50 transition ${getSLAClass(j.Timestamp, j.Status)}">
                    <td class="p-4">
                        <span class="text-[10px] text-gray-400 block font-bold tracking-widest">${j.JobID}</span>
                        <span class="text-[9px] text-gray-400">${calculateTimeDiff(j.Timestamp)}</span>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-gray-700">${j.Problem}</div>
                        <div class="text-[10px] text-gray-400">${j.Department}</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="text-[10px] font-bold ${j.Priority === '‡∏î‡πà‡∏ß‡∏ô' ? 'text-red-500' : 'text-gray-400'}">${j.Priority || '‡∏õ‡∏Å‡∏ï‡∏¥'}</span>
                    </td>
                    <td class="p-4 text-center">
                        <span class="status-pill ${getStatusStyle(j.Status)}">${j.Status}</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="viewJobDetail('${j.JobID}')" class="bg-gray-100 p-2.5 rounded-xl hover:bg-pink-100 transition shadow-sm">üîç</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderStatCard(label, val, color) {
            return `
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 text-center">
                    <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">${label}</p>
                    <p class="text-2xl font-bold" style="color: ${color}">${val}</p>
                </div>
            `;
        }

        function getStatusStyle(s) {
            const map = {
                '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô': 'bg-orange-100 text-orange-600',
                '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 'bg-blue-100 text-blue-600',
                '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': 'bg-green-100 text-green-600',
                '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': 'bg-purple-100 text-purple-600'
            };
            return map[s] || 'bg-gray-100 text-gray-600';
        }

        // --- SLA CALCULATION ---
        function getSLAClass(ts, status) {
            if (status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') return '';
            const diffMin = (new Date() - new Date(ts)) / 60000;
            if (diffMin > 120) return 'sla-red';
            if (diffMin > 60) return 'sla-yellow';
            return 'sla-green';
        }

        function calculateTimeDiff(ts) {
            const diff = Math.floor((new Date() - new Date(ts)) / 60000);
            if (diff < 60) return diff + " ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
            return Math.floor(diff/60) + " ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        }

        // --- JOB DETAIL & ACTIONS ---
        function viewJobDetail(id) {
            const j = store.JobTicket.find(x => x.JobID === id);
            if(!j) return;

            document.getElementById('md-job-id').innerText = j.JobID;
            document.getElementById('md-dept').innerText = j.Department;
            document.getElementById('md-asset').innerText = j.AssetID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('md-problem').innerText = j.Problem;
            document.getElementById('md-timestamp').innerText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + new Date(j.Timestamp).toLocaleString('th-TH');

            let actionHtml = '';
            
            // ROLE-BASED ACTIONS
            if (currentUser.UserTypeID === 'Supervisor') {
                actionHtml += `<button onclick="assignJob('${j.JobID}')" class="bg-purple-600 text-white px-6 py-3 rounded-2xl font-bold shadow-md">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á</button>`;
            }

            if (j.Status === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô') {
                actionHtml += `<button onclick="updateJobStatus('${j.JobID}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold shadow-md">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>`;
            } else if (j.Status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                actionHtml += `<button onclick="updateJobStatus('${j.JobID}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" class="bg-green-600 text-white px-6 py-3 rounded-2xl font-bold shadow-md">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>`;
            }

            document.getElementById('md-actions').innerHTML = actionHtml;
            openModal('modal-detail');
        }

        async function updateJobStatus(id, status) {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...");
            const data = { JobID: id, Status: status, Owner: currentUser.UserName };
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateJobStatus', data }) });
            const result = await res.json();
            if(result.success) {
                closeModal('modal-detail');
                loadMasterData();
            }
        }

        // --- SYSTEM LINKS ---
        function renderLinks() {
            const area = document.getElementById('tab3');
            area.innerHTML = store.SystemLink.map(l => `
                <a href="${l.URL}" target="_blank" class="card-custom p-6 flex flex-col items-center justify-center text-center gap-3">
                    <img src="${l.Linkicon}" class="w-12 h-12 object-contain" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2065/2065157.png'">
                    <span class="text-xs font-bold text-gray-600">${l.Name}</span>
                </a>
            `).join('');
        }

        // --- FORM LOGIC ---
        function setupFormLists() {
            document.getElementById('dept-list').innerHTML = store.Department.map(d => `<option value="${d.DepartmentName}">${d.DeptNOID}</option>`).join('');
            document.getElementById('asset-list').innerHTML = store.BackupData.map(a => `<option value="${a.AssetID}">${a.AssetName}</option>`).join('');
            document.getElementById('f-type').innerHTML = store.JobTypeMaster.map(t => `<option value="${t.TypeName}">${t.TypeName}</option>`).join('');
            updateSubTypes();
        }

        function updateSubTypes() {
            const main = document.getElementById('f-type').value;
            const subs = store.JobSubTypeMaster.filter(s => s.MainTypeName === main);
            document.getElementById('f-sub').innerHTML = subs.map(s => `<option value="${s.SubTypeName}">${s.SubTypeName}</option>`).join('');
        }

        function openFormModal() { openModal('modal-form'); }

        async function submitITTicket() {
            const data = {
                JobID: "IT" + Date.now().toString().slice(-6),
                JobType: document.getElementById('f-type').value,
                JobSubType: document.getElementById('f-sub').value,
                Department: document.getElementById('f-dept').value,
                AssetID: document.getElementById('f-asset').value,
                Detail: document.getElementById('f-detail').value,
                CreateBy: currentUser.UserName
            };

            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveITTicket', data }) });
            const result = await res.json();
            if(result.success) {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                closeModal('modal-form');
                loadMasterData();
            }
        }

        function switchTab(n) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + n).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('text-pink-500', 'border-pink-500', 'font-bold');
                b.classList.add('text-gray-400');
            });
            document.getElementById('t' + n).classList.add('text-pink-500', 'border-pink-500', 'font-bold');
        }

        function logout() {
            sessionStorage.clear();
            location.reload();
        }

        // INIT
        window.onload = loadMasterData;
    </script>
</body>
</html>
