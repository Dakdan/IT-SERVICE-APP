<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö - IT Maintenance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body class="login-page">

<div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>

<div id="popup" class="popup-overlay">
  <div class="popup-box">
    <div class="popup-icon" style="font-size: 3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
    <h3 id="popup-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
    <p id="popup-message"></p>
    <button onclick="closePopup()" class="btn-login" style="margin-top: 20px; padding: 10px;">‡∏ï‡∏Å‡∏•‡∏á</button>
  </div>
</div>

<div class="login-wrapper">

  <header class="login-header">
    <img src="./‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ.png" class="header-logo" alt="Udon Hospital Logo">
    <h1>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</h1>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
  </header>

  <main class="login-card">

    <div class="form-group">
      <label for="username">üë§ Email / Username</label>
      <input type="text" id="username" autocomplete="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
    </div>

    <div class="form-group">
      <label for="password">üîí Password</label>
      <input type="password" id="password" autocomplete="current-password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    </div>

    <button class="btn-login" onclick="handleLogin()">
      üõ°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    </button>

    <div class="card-footer" style="text-align:center; margin-top:20px; font-size: 0.9rem; color: #666;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô? <a href="register.html" style="font-weight: 600;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
    </div>

  </main>
</div>

<script src="./js/api.js"></script>
<script src="./js/main.js"></script>

<script>
  // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Session (Auto Login)
  window.addEventListener('DOMContentLoaded', () => {
    const session = localStorage.getItem("it_session");
    if (session) {
      location.href = "./index.html";
    }
  });

  // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Login
  async function handleLogin() {
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');

    const username = userEl.value.trim();
    const password = passEl.value.trim();

    // Validation
    if (!username || !password) {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å main.js
      if (window.showPopup) {
        showPopup("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
      } else {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password");
      }
      return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á Loader (‡πÉ‡∏ä‡πâ Loader object ‡∏à‡∏≤‡∏Å main.js)
    if (window.Loader) Loader.show();

    try {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ ApiService ‡∏à‡∏≤‡∏Å api.js
      const result = await ApiService.login(username, password);

      if (result.success) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session (‡πÉ‡∏ä‡πâ Auth object ‡∏à‡∏≤‡∏Å main.js)
        if (window.Auth) {
          Auth.setSession(result.user);
        } else {
          localStorage.setItem("it_session", JSON.stringify(result.user));
        }
        location.href = "./index.html";
      } else {
        showPopup("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", result.message || "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    } catch (error) {
      console.error("Login Error:", error);
      showPopup("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");
    } finally {
      // ‡∏õ‡∏¥‡∏î Loader
      if (window.Loader) Loader.hide();
    }
  }

  // 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á User Experience: ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Login
  document.getElementById('password').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
  async function handleLogin() {
    console.log("Button Clicked!"); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Console

    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const username = userEl.value.trim();
    const password = passEl.value.trim();

    if (!username || !password) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }

    if (window.Loader) Loader.show();

    try {
      console.log("Calling API...");
      const result = await ApiService.login(username, password);
      console.log("API Result:", result);

      if (result.success) {
        Auth.setSession(result.user);
        location.href = "./index.html";
      } else {
        showPopup("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", result.message);
      }
    } catch (e) {
      console.error(e);
      showPopup("Error", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    } finally {
      if (window.Loader) Loader.hide();
    }
}
</script>

</body>
</html>
